<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/inscription.css">
    <title>Formulaire d'inscription</title>
</head>

<body>
    <div id=divdroit> <img src="https://www.educol.net/coloriage-maison-dl28263.jpg" width="40px" alt=""></a></div>

    <legend>
        <form id="formInscription">
            <h1>Formulaire d'inscription</h1>
            <p>Les champs marqués d'une étoiles sont obligatoires (la photo ne l'est pas)</p>
            <table>
                <tr>
                    <td colspan="2"><input id="email" placeholder="email*" type="email" name="email" required></td>
                </tr>
                <tr>
                    <td colspan="2"><input id="password" placeholder="password*" type="password" name="password"
                            required></button></td>
                </tr>
                <tr>
                    <td colspan="2"><input id="prenom" placeholder="prenom*" type="text" name="prenom" required> </td>
                </tr>
                <tr>
                    <td colspan="2"><input id="nom" placeholder="nom*" type="text" name="nom" required></td>
                </tr>
                <tr>
                    <td colspan="2">Genre :
                        <input type="radio" id="genre" name="genre" value="Homme" class="pointer" required><span
                            class="pointer" onclick="Checked('Homme')">Homme</span>
                        <input type="radio" id="genre" name="genre" value="Femme" class="pointer" required><span
                            class="pointer" onclick="Checked('Femme')">Femme</span>
                        <input type="radio" id="genre" name="genre" value="Autre" class="pointer" required><span
                            class="pointer" onclick="Checked('Autre')">Autre</span>
                    </td>
                </tr>
                <tr>
                    <td colspan="2"><input id="age" placeholder="age*" type="number" min="13" max="110" name="age"
                            required>
                    </td>
                </tr>
                <tr>
                    <td colspan="2"><input id="departement" placeholder="departement" name="departement" required></td>
                </tr>
                <tr>
                    <td colspan="2"><input id="ville" placeholder="ville*" name="ville" required></td>
                </tr>
                <tr>
                    <td colspan="2"><input id="rue" placeholder="rue*" name="nom de la rue" required></td>
                </tr>
                <tr>
                    <td colspan="2"><input id="numrue" placeholder="numéro de rue*" type="number" min="1"
                            name="numéro de rue" required>
                    </td>
                </tr>
                <tr>
                    <td colspan="2"><input input id="id1" type="file" accept=".png" name="photo"></td>
                </tr>
                <tr>
                    <td><button id="connexion" type="button" onclick="Connect()">Se connecter ?</button></td>
                    <td><button id="inscription" type="submit">s'inscrire</button></td>
                </tr>
            </table>
    </legend>
    </form>

<script scr="inscription.js">
    console.log("Script chargé !");
    document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM chargé"); // Vérifie si le DOM est bien chargé

        document.getElementById('formInscription').addEventListener('submit', function (event) {
            event.preventDefault();  // Empêche la soumission du formulaire classique
            console.log("Le formulaire est soumis");
            ajouterElement(event);
        });
    });

    async function recupidVille(nom, departement) {
        try {
            const response = await fetch(`http://localhost:5000/Recherche_Ville_nom_departement?nom=${encodeURIComponent(nom)}&departement=${encodeURIComponent(departement)}`);
            const data = await response.json();

            if (data.length === 0) {
                console.log('Aucune ville trouvée.');
                return -1;
            }

            const villeId = data[0].id; // Récupération du premier ID
            console.log('ID de la ville :', villeId);
            return villeId;
        } catch (error) {
            console.error('Erreur:', error);
            return -1;
        }
    }

    async function recupidResidence(idVille, rue, numrue) {
        try {
            const response = await fetch(`http://localhost:5000/Recherche_Residence_ville_num_rue?num=${numrue}&idv=${idVille}&rue=${encodeURIComponent(rue)}`);
            const data = await response.json();

            if (data.length === 0) {
                console.log('Aucune résidence trouvée.');
                return -1;
            }

            const residenceId = data[0].id; // Récupération du premier ID
            console.log('ID de la résidence:', residenceId);
            return residenceId;
        } catch (error) {
            console.error('Erreur:', error);
            return -1;
        }
    }

    async function ajouterElement(event) {
        event.preventDefault();
        console.log("Début de la fonction ajouterElement");

        const prenom = document.getElementById("prenom").value;
        const nom = document.getElementById("nom").value;
        const mail = document.getElementById("email").value;
        const mdp = document.getElementById("password").value;
        const genre = document.querySelector('input[name="genre"]:checked').value;
        const age = document.getElementById("age").value;
        const ville = document.getElementById("ville").value;
        const departement = document.getElementById("departement").value;
        const rue = document.getElementById("rue").value;
        const numrue = document.getElementById("numrue").value;
        const adressephoto = mail + ".png";

        try {
            const idVille = await recupidVille(ville, departement);
            if (idVille < 0) {
                alert("Ville non trouvée");
                return;
            }

            const idResidence = await recupidResidence(idVille, rue, numrue);
            if (idResidence < 0) {
                alert("Adresse non trouvée");
                return;
            }

            const residentData = {
                prenom: prenom,
                nom: nom,
                mail: mail,
                mdp: mdp,
                age: age,
                abonnement: "gratuit", // Valeur par défaut
                idResidence: idResidence,
                adressephoto: adressephoto,
                genre: genre
            };

            console.log("Données à envoyer:", residentData);

            const response = await fetch('http://localhost:5000/Creer_Resident', {
                method: 'POST',
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(residentData)
            });

            const result = await response.text();
            console.log("Réponse du serveur:", result);
            alert(result);

            // Gérer l'upload de la photo si nécessaire
            const fileInput = document.getElementById("id1");
            if (fileInput.files.length > 0) {
                // Code pour uploader la photo
            }
        } catch (error) {
            console.error('Erreur:', error);
            alert("Une erreur est survenue lors de l'inscription");
        }
    }

    function Connect() {
        window.location.href = "connexion.php";
    }
</script>
</body>

</html>